<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'style.css' %}" />
    <link
      rel="icon"
      href="{% static 'img/icon/NewTitle.ico' %}"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="{% static 'templatemo-style.css' %}" />
    <link rel="stylesheet" href="{% static 'image.css' %}" />

    <title>Pratinjau Gabungan Motif</title>

    <style>
      .image-container {
        width: 100vw;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .image-container img {
        width: 100%;
        height: auto;
        object-fit: contain;
        max-width: 100%;
        max-height: 100%;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
        /* Menghapus filter kontras dan brightness */
        {% comment %} filter: contrast(1.5) brightness(1.2) saturate(1.3); {% endcomment %}
      }

      .container {
        display: flex;
        flex-direction: column;
        gap: 0;
        align-items: center;
        margin: 0 !important;
        padding: 0 !important;
      }

      .image-container div {
        text-align: center;
      }

      .lidi {
        text-align: center;
        margin: 5px 0 0 10px;
        padding: 5px 15px;
        font-size: 1.2rem;
        line-height: 1.2;
        font-weight: bold;
        color: #333;
        background-color: #f8f9fa;
        white-space: nowrap;
      }

      #download-buttons a {
        margin: 0 5px;
        padding: 12px 24px;
        font-size: 1.2rem;
        text-align: center;
        width: 250px;
        border-radius: 0px;
      }

      .title-text {
        font-size: 2rem;
        font-weight: bold;
        color: #002ba3;
        text-align: center;
        margin: 0 !important;
        padding: 0 !important;
        text-decoration: underline;
      }

      .info-text {
        text-align: justify;
        margin: 10px 20px !important;
        padding: 5px 0 !important;
        font-size: 1.5rem;
        font-weight: normal;
        color: #333;
      }

      #image-section {
        margin: 0 !important;
        padding: 0 !important;
      }

      #image-section p:first-child {
        margin-top: 0 !important;
      }

      .motif-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin: 0;
        padding: 0;
        width: 100%;
      }

      .lidi-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 150px;
      }

      .download-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      #download-buttons {
        display: flex;
        flex-direction: row;
        gap: 10px;
        align-items: center;
        margin: 0;
        padding: 0;
      }

      #back-button {
        display: flex;
        justify-content: center;
        width: 100%;
        margin-top: 10px;
        padding: 0;
        border-radius: 0px;
      }

      #back-button a {
        background-color: transparent;
        border: 2px solid #002ba3;
        border-radius: 0px;
        padding: 12px 30px 14px;
        font-size: 1rem;
        color: #002ba3;
        text-decoration: none;
        display: inline-block;
        width: 250px;
      }

      .info-box {
        width: 100%;
        max-width: 800px;
        margin: 20px auto;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #ddd;
      }

      .info-box-download {
        width: 100%;
        max-width: 800px;
        margin: 0 auto 10px auto;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #ddd;
        display: none;
      }

      .download-header {
        text-align: center;
        font-size: 2rem;
        font-weight: bold;
        color: #002ba3;
        margin-bottom: 15px;
        padding: 0;
      }

      .download-info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        padding: 3px 0;
        border-bottom: 1px solid #eee;
      }

      .download-info-label {
        font-weight: bold;
        width: 40%;
        text-align: left;
        padding-right: 10px;
        font-size: 1.8rem;
      }

      .download-info-value {
        width: 60%;
        text-align: left;
        font-size: 1.4rem;
      }

      @media (max-width: 768px) {
        .image-container {
          width: 100vw;
        }
        .image-container img {
          width: 100%;
        }
        .motif-row {
          flex-direction: column;
          align-items: center;
          gap: 5px;
        }
        .lidi {
          font-size: 1rem;
          margin: 5px 0 0 5px;
          padding: 3px 10px;
        }
        .info-text {
          font-size: 1.1rem;
          margin: 5px 10px !important;
          padding: 3px 0 !important;
        }
        .title-text {
          font-size: 1.5rem;
        }
        #download-buttons {
          flex-direction: column;
          gap: 5px;
        }
        #download-buttons a {
          width: 100%;
          margin: 0 0 5px 0;
        }
        .download-container {
          max-width: 95%;
        }
        #back-button {
          margin-top: 5px;
        }
        #back-button a {
          width: 100%;
        }
        .info-box {
          max-width: 95%;
          padding: 10px;
        }
        .info-box-download {
          max-width: 95%;
          padding: 8px;
        }
        .download-header {
          font-size: 1.5rem;
          margin-bottom: 10px;
          text-align: left;
        }
        .download-info-row {
          flex-direction: column;
        }
        .download-info-label,
        .download-info-value {
          width: 100%;
          text-align: left;
          font-size: 1.2rem;
        }
      }
    </style>
  </head>
  <body>
    {% include "header.html" %}
    <br />
    <p class="title-text">Lembar Kerja Motif Tenun</p>

    <!-- Info box yang ditampilkan di halaman -->
    <div class="info-box">
      <p class="info-text">Nama Pembuat: {{ user }}</p>
      <p class="info-text">Tanggal Pembuatan: {{ date_now }}</p>
      <p class="info-text">Jenis Kain: {{ motif.jenisKain|default:"-" }}</p>
      <p class="info-text">Jenis Produk: {{ motif.jenisProduk|default:"-" }}</p>
      <p class="info-text">
        Ukuran: {% if motif.jenisProduk == 'sarung' %} Panjang 200-210 cm, Lebar
        95-97 cm {% elif motif.jenisProduk == 'selendang' %} Panjang 190-200 cm,
        Lebar 60-70 cm {% else %} - {% endif %}
      </p>
    </div>

    <!-- Info box untuk unduhan -->
    <div id="info-box-download" class="info-box-download">
      <div class="download-header">INFORMASI MOTIF TENUN</div>
      <div class="download-info-row">
        <div class="download-info-label">Nama Pembuat:</div>
        <div class="download-info-value">{{ user }}</div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Tanggal Pembuatan:</div>
        <div class="download-info-value">{{ date_now }}</div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Jenis Kain:</div>
        <div class="download-info-value">{{ motif.jenisKain|default:"-" }}</div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Jenis Produk:</div>
        <div class="download-info-value">
          {{ motif.jenisProduk|default:"-" }}
        </div>
      </div>
      <div class="download-info-row">
        <div class="download-info-label">Ukuran:</div>
        <div class="download-info-value">
          {% if motif.jenisProduk == 'sarung' %} Panjang 200-210 cm, Lebar 95-97
          cm {% elif motif.jenisProduk == 'selendang' %} Panjang 190-200 cm,
          Lebar 60-70 cm {% else %} - {% endif %}
        </div>
      </div>
    </div>

    <div
      class="container"
      style="
        max-width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        margin: 0;
        padding: 0;
      "
    >
      <div
        id="image-section"
        style="
          width: 100%;
          display: flex;
          flex-direction: column;
          gap: 0;
          align-items: center;
          margin: 0;
          padding: 0;
        "
      >
        {% for Motif1, Motif2 in slice %}
        <div
          class="motif-row"
          style="gap: 0; margin: 0; padding: 0; line-height: 0"
        >
          <div
            class="image-container grid-overlay"
            style="width: 90%; margin: 0; padding: 0; flex-shrink: 0"
          >
            <img
              src="{{ Motif1 }}"
              data-nama-gambar="Lidi {{ Motif2 }}"
              style="
                width: 100%;
                height: auto;
                object-fit: contain;
                margin: 0;
                padding: 0;
              "
            />
          </div>
          <div
            class="lidi"
            style="text-align: center; margin: 0; padding: 0; line-height: 0"
          >
            Lidi {{ Motif2 }}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <canvas
      id="canvasWrapper"
      style="width: 100%; height: auto"
      hidden
    ></canvas>
    <br />
    <div class="download-container">
      <div id="download-buttons" style="margin: 0; padding: 0">
        <a class="btn btn-primary" onclick="renderDivToImage('png')"
          >Unduh Motif (PNG)</a
        >
        <a class="btn btn-primary" onclick="renderDivToImage('jpg')"
          >Unduh Motif (JPG)</a
        >
        <a class="btn btn-primary" onclick="renderDivToImage('pdf')"
          >Unduh Motif (PDF)</a
        >
      </div>
      <div id="back-button">
        <a
          class="btn btn-primary"
          href="/ubah_warna_combined/{{ motif.id }}"
          style="color: #002ba3"
          >Kembali</a
        >
      </div>
    </div>

    <img
      id="hiddenCombinedImage"
      src="{{ combined_image_url }}"
      style="display: none"
    />
    <br />

    {% include "footer.html" %}

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
      defer
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const { jsPDF } = window.jspdf;

        // Fungsi untuk menerapkan kontras pada canvas
        function applyContrast(ctx, width, height, contrast) {
          const imageData = ctx.getImageData(0, 0, width, height);
          const data = imageData.data;
          const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

          for (let i = 0; i < data.length; i += 4) {
            data[i] = factor * (data[i] - 128) + 128; // Red
            data[i + 1] = factor * (data[i + 1] - 128) + 128; // Green
            data[i + 2] = factor * (data[i + 2] - 128) + 128; // Blue
          }
          ctx.putImageData(imageData, 0, 0);
        }

        function renderDivToImage(format) {
          console.log("Starting renderDivToImage with format:", format);
          window.scrollTo(0, 0);

          const infoBoxDownload = document.getElementById("info-box-download");
          if (!infoBoxDownload) {
            alert("Info box tidak ditemukan!");
            return;
          }
          infoBoxDownload.style.display = "block";

          const captureDiv = document.createElement("div");
          captureDiv.id = "capture-div";
          captureDiv.style.width = "100%";
          captureDiv.style.margin = "0";
          captureDiv.style.padding = "10px 0 0 0";
          captureDiv.style.display = "flex";
          captureDiv.style.flexDirection = "column";
          captureDiv.style.alignItems = "center";

          const titleDiv = document.createElement("div");
          titleDiv.style.textAlign = "center";
          titleDiv.style.marginBottom = "10px";
          const title = document.createElement("h1");
          title.style.color = "#002ba3";
          title.style.margin = "0";
          title.style.padding = "0";
          title.style.fontSize = "2rem";
          // title.innerText = "LEMBAR KERJA MOTIF TENUN";
          titleDiv.appendChild(title);

          captureDiv.appendChild(titleDiv);
          captureDiv.appendChild(infoBoxDownload.cloneNode(true));
          const imageSection = document.getElementById("image-section");
          if (!imageSection) {
            alert("Image section tidak ditemukan!");
            document.body.removeChild(captureDiv);
            infoBoxDownload.style.display = "none";
            return;
          }
          const clonedImageSection = imageSection.cloneNode(true);
          captureDiv.appendChild(clonedImageSection);

          // Terapkan filter kontras ke gambar dalam clonedImageSection
          const images = clonedImageSection.querySelectorAll("img");
          images.forEach((img) => {
            img.crossOrigin = "anonymous";
            img.style.filter = "none"; // Pastikan kontras diterapkan
            if (!img.complete || img.naturalHeight === 0) {
              console.error("Gambar gagal dimuat:", img.src);
            }
          });

          console.log(
            "CaptureDiv created with children:",
            captureDiv.children.length
          );

          infoBoxDownload.style.display = "none";
          document.body.appendChild(captureDiv);

          const loadingIndicator = document.createElement("div");
          loadingIndicator.id = "loading-indicator";
          loadingIndicator.style.position = "fixed";
          loadingIndicator.style.top = "50%";
          loadingIndicator.style.left = "50%";
          loadingIndicator.style.transform = "translate(-50%, -50%)";
          loadingIndicator.style.padding = "20px";
          loadingIndicator.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
          loadingIndicator.style.color = "white";
          loadingIndicator.style.borderRadius = "0px";
          loadingIndicator.style.zIndex = "1000";
          loadingIndicator.innerText = "Memproses...";
          document.body.appendChild(loadingIndicator);

          html2canvas(captureDiv, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            width: captureDiv.scrollWidth,
            height: captureDiv.scrollHeight,
            windowWidth: captureDiv.scrollWidth,
            windowHeight: captureDiv.scrollHeight,
          })
            .then((canvas) => {
              const ctx = canvas.getContext("2d");
              // Terapkan kontras 220.3 pada canvas
              applyContrast(ctx, canvas.width, canvas.height, 0);

              console.log("Canvas generated:", canvas.width, canvas.height);
              document.body.removeChild(captureDiv);
              document.body.removeChild(loadingIndicator);

              if (format === "pdf") {
                const pdf = new jsPDF("p", "mm", "a4");
                const imgData = canvas.toDataURL("image/jpeg", 0.8);
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = canvas.width * 0.264583;
                const imgHeight = imgWidth * (canvas.height / canvas.width);
                const scaleFactor = Math.min(
                  pageWidth / imgWidth,
                  (pageHeight - 140) / imgHeight
                );
                const scaledWidth = imgWidth * scaleFactor;
                const scaledHeight = imgHeight * scaleFactor;
                const xOffset = (pageWidth - scaledWidth) / 2;
                const yOffset = 55;

                console.log(
                  "PDF dimensions:",
                  pageWidth,
                  scaledWidth,
                  scaledHeight
                );
                // Tambahkan logo dengan penanganan kesalahan
                const logo1 = new Image();
                logo1.src = "/{{ ditenun_logo_1 }}";
                logo1.crossOrigin = "anonymous";
                logo1.onload = () => {
                  pdf.addImage(logo1, "PNG", 20, 20, 30, 30);
                  const logo2 = new Image();
                  logo2.src = "/{{ ditenun_logo_2 }}";
                  logo2.crossOrigin = "anonymous";
                  logo2.onload = () => {
                    pdf.addImage(logo2, "PNG", pageWidth - 50, 20, 30, 30);
                    pdf.setFontSize(20);
                    pdf.text("LEMBAR KERJA MOTIF TENUN", pageWidth / 2, 40, {
                      align: "center",
                    });
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.9);
                    pdf.line(30, 55, pageWidth - 30, 55);
                    pdf.addImage(
                      imgData,
                      "JPEG",
                      xOffset,
                      yOffset,
                      scaledWidth,
                      scaledHeight
                    );
                    pdf.save(
                      `lembar_kerja_motif_tenun_${new Date()
                        .toISOString()
                        .slice(0, 10)}.pdf`
                    );
                  };
                  logo2.onerror = () => {
                    console.error("Gagal memuat logo 2:", logo2.src);
                    alert(
                      "Gagal memuat logo kedua. PDF akan diunduh tanpa logo kedua."
                    );
                    pdf.setFontSize(20);
                    pdf.text("LEMBAR KERJA MOTIF TENUN", pageWidth / 2, 40, {
                      align: "center",
                    });
                    pdf.setDrawColor(0, 0, 0);
                    pdf.setLineWidth(0.9);
                    pdf.line(30, 55, pageWidth - 30, 55);
                    pdf.addImage(
                      imgData,
                      "JPEG",
                      xOffset,
                      yOffset,
                      scaledWidth,
                      scaledHeight
                    );
                    pdf.save(
                      `lembar_kerja_motif_tenun_${new Date()
                        .toISOString()
                        .slice(0, 10)}.pdf`
                    );
                  };
                };
                logo1.onerror = () => {
                  console.error("Gagal memuat logo 1:", logo1.src);
                  alert(
                    "Gagal memuat logo pertama. PDF akan diunduh tanpa logo pertama."
                  );
                  pdf.setFontSize(20);
                  pdf.text("LEMBAR KERJA MOTIF TENUN", pageWidth / 2, 40, {
                    align: "center",
                  });
                  pdf.setDrawColor(0, 0, 0);
                  pdf.setLineWidth(0.9);
                  pdf.line(30, 55, pageWidth - 30, 55);
                  pdf.addImage(
                    imgData,
                    "JPEG",
                    xOffset,
                    yOffset,
                    scaledWidth,
                    scaledHeight
                  );
                  pdf.save(
                    `lembar_kerja_motif_tenun_${new Date()
                      .toISOString()
                      .slice(0, 10)}.pdf`
                  );
                };
              } else {
                const link = document.createElement("a");
                link.href = canvas.toDataURL(`image/${format}`, 0.8);
                link.download = `lembar_kerja_motif_tenun_${new Date()
                  .toISOString()
                  .slice(0, 10)}.${format}`;
                link.click();
              }
            })
            .catch((error) => {
              document.body.removeChild(loadingIndicator);
              document.body.removeChild(captureDiv);
              console.error("Kesalahan saat membuat gambar:", error);
              alert("Terjadi kesalahan saat membuat unduhan: " + error.message);
            });
        }

        window.renderDivToImage = renderDivToImage;

        const submitCanvasImages = () => {
          console.log("Fungsi submitCanvasImages belum diimplementasikan.");
        };
        window.submitCanvasImages = submitCanvasImages;

        // Periksa apakah gambar dimuat saat halaman dimuat
        const images = document.querySelectorAll(".image-container img");
        images.forEach((img) => {
          img.crossOrigin = "anonymous";
          img.addEventListener("error", () => {
            console.error("Gagal memuat gambar:", img.src);
            alert("Gagal memuat gambar: " + img.src);
          });
        });
      });
    </script>
  </body>
</html>
